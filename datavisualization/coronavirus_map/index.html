<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Coronavirus Hot Spot Map</title>
        <link rel="stylesheet" href="index.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.2/semantic.min.css"/>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
                integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
                crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
                integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
                crossorigin=""></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src='https://api.mapbox.com/mapbox.js/v3.3.0/mapbox.js'></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
        <link href='https://api.mapbox.com/mapbox.js/v3.3.0/mapbox.css' rel='stylesheet'/> 
    </head>
    <style>
        body {
            background-color: rgb(20, 20, 20); 
            height: 100%;
            width: 100%;
            font-family: sans-serif;
        }

        h1, h2, h3, h4 {
            font-family: sans-serif;
        }

        .leaflet-popup-content-wrapper {
            background-color: black;
        }
    </style>

    <body>
        <div id="titleBar">
            <h1>COVID-19 <span style="color: #ed2d1f;">New Daily Cases</span> and <span style="color: gold;">Active Cases</span> Global Hot Spots</h1>
        </div>
        <div id="mainGrid">
            <div id="map"></div>
            <div class="ui equal width grid" id="info">
                <!-- <div class="row">
                    <div class="column" style="margin-bottom: -3em; margin-top: -0.2em;">
                        <h1 id="infoTitle">Global Data</h1>
                    </div>
                </div> -->
                <div class="row" style="margin-bottom: -2em; margin-top: -1em; padding-left: 1em; padding-right: 1em;">
                    <div class="column">
                        <h3>Daily Increase</h3>
                        <strong id="changeCount"></strong>
                    </div>
                    <div class="column">
                        <h3>Active Cases</h3>
                        <strong id="activeCount"></strong>
                    </div>
                </div>
                <div class="row" style="padding-left: 1em; padding-right: 1em;">
                    <div class="column">
                        <h3>Recovered</h3>
                        <strong id="recoveredCount"></strong>
                    </div>
                    <div class="column">
                        <h3>Deaths</h3>
                        <strong id="deathCount"></strong>
                    </div>
                </div>
                <div class="row">
                    <div class="column">
                        <h1 id="infoTitle">Global Data</h1>
                        <h1 style="font-size: 1.25em; margin-top: 0;">Time Series Chart</h1>
                        <canvas id="infectionChart" height=150></canvas>
                        <div class="four ui buttons mini">
                            <button class="ui yellow button mini" id="activeButton" onclick="clickChartButton('activeButton')">Active Cases</button>
                            <button class="ui blue button mini" id="recoveredButton" onclick="clickChartButton('recoveredButton')">Recovered</button>
                            <button class="ui purple button mini" id="deathButton" onclick="clickChartButton('deathButton')">Deaths</button>
                            <button class="ui red basic button mini" id="increaseButton" onclick="clickIncreaseButton()">Daily Change</button>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-top: -1em;">
                    <div class="column legend" style="padding-left: 6em; padding-right: 6em; margin-top: -0.5em;">
                        <h4>Number of New Cases</h4>
                        <div class="row" style="height: 1em;">
                            <i style="background: #ed2d1f;"></i><div style="font-size: 0.85em;">1000+</div>
                        </div>
                        <div class="row" style="height: 1em;">
                            <i style="background: #f37240;"></i><div style="font-size: 0.85em;">500-1000</div>
                        </div>
                        <div class="row" style="height: 1em;">
                            <i style="background: #f8a36f;"></i><div style="font-size: 0.85em;">50-500</div>
                        </div>
                        <div class="row" style="height: 1em;">
                            <i style="background: #fccda8;"></i><div style="font-size: 0.85em;">10-50</div>
                        </div>
                        <div class="row" style="height: 1em;">
                            <i style="background: #fff4e9;"></i><div style="font-size: 0.85em;">0-10</div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="column">
                        <p style="font-size: 0.8em; margin-top: -2.3em;" id="lastUpdated"></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <p>Developed by Justin Bishay, Computer Science M.S. Student, <a href="https://jkbishay.github.io/" target="_blank">Website</a></p>
            <div class="ui three column grid" style="margin-top: -2em; padding-left: 9%; padding-right: 9%; font-size: 0.9em;">
                <div class="column">
                    <p>
                        <a href="http://datascience.hawaii.edu/" target="_blank" style="color: lightgray;">
                            <img target="_blank" src="./HIDSILogo.png" style="width: 20px; height: 20px;"/> Hawaiʻi Data Science Institute 
                        </a>
                    </p>
                </div>
                <div class="column">
                    <p>
                        <a href="https://www.lavaflow.info/" target="_blank" style="color: lightgray;">
                            <img target="_blank" src="./lavaLogo.png" style="width: 45px; height: 22px;"/> Laboratory for Advanced Visualization & Applications 
                        </a>
                    </p>
                </div>
                <div class="column">
                    <p>
                        <a href="https://manoa.hawaii.edu/" target="_blank" style="color: lightgray;">
                            <img target="_blank" src="./UHMLogo.png" style="width: 20px; height: 20px;"/> University of Hawaiʻi at Mānoa 
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </body>

    <script>
        // process current and previous date 
        // NOTE: currently set to update at 12:00 AM UTC
        var d = new Date();
        var currentDay;
        if (d.getUTCDate() < 10) {
            currentDay = '0' + (d.getUTCDate() - 1);
        }
        else {
            currentDay = '' + (d.getUTCDate() - 1);
        }

        var currentMonth;
        if (d.getUTCMonth() + 1 < 10) {
            currentMonth = '0' + (d.getUTCMonth() + 1);
        }
        else {
            currentMonth = '' + (d.getUTCMonth() + 1);
        }
        var currentYear = d.getUTCFullYear();

        var previousDay = currentDay - 1;
        var previousMonth = currentMonth;
        var previousYear = currentYear;
        // if month has changed
        if (previousDay <= 0) {
            switch(currentMonth - 1) {
                case 1:
                case 3:
                case 5:
                case 7:
                case 8:
                case 10:
                    previousDay = 31;
                    if (currentMonth - 1 < 10) {
                        previousMonth = '0' + (currentMonth - 1);
                    }
                    else {
                        previousMonth = '' + (currentMonth - 1);
                    }
                    break;
                case 2:
                    if (currentYear % 4 == 0) {
                        previousDay = 29;
                    }
                    else {
                        previousDay = 28;
                    }
                    previousMonth = '0' + (currentMonth - 1);
                    break;
                case 4:
                case 6:
                case 9:
                case 11:
                    previousDay = 30;
                    if (currentMonth - 1 < 10) {
                        previousMonth = '0' + (currentMonth - 1);
                    }
                    else {
                        previousMonth = '' + (currentMonth - 1);
                    }
                    break;
                // THIS IS DECEMBER
                case 0:
                    previousDay = 31;
                    previousYear--;
                    previousMonth = '12';
                    break;
            }
        }

        // process data
        Promise.all([
            d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/" + previousMonth + "-" + previousDay + "-" + previousYear + ".csv"),
            d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_daily_reports/" + currentMonth + "-" + currentDay + "-" + currentYear + ".csv"),
            d3.csv("./statelatlong.csv")
        ]).then(function (data) {
            // global totals counters
            var globalActive = 0;
            var globalRecovered = 0;
            var globalDeaths = 0;
            var globalNewCases = 0;

            var markers = [];
            var radii = [1, 2, 3, 6, 8, 11, 14];

            // process data for non-USA regions
            for (let i = 0; i < data[1].length; i++) {
                var today = data[1][i];
                if (today.Country_Region !== 'US' && today.Confirmed != 0) {
                    var yesterday = data[0].find(item => item['Country_Region'] === today['Country_Region'] && item['Province_State'] === today['Province_State']);
                    plotPoint(today, yesterday);
                }
                else if (today.Country_Region === 'US' && today.Province_State === 'Recovered') {
                    globalRecovered += parseInt(today.Recovered, 10);
                }
            }

            // process data for USA by state
            for (let i = 0; i < data[2].length; i++) {
                var conf = 0;
                var rec = 0;
                var dead = 0;

                // today's data
                for (let j = 0; j < data[1].length; j++) {
                    if (data[1][j].Province_State === data[2][i].City) {
                        conf += parseInt(data[1][j].Confirmed, 10);
                        rec += parseInt(data[1][j].Recovered, 10);
                        dead += parseInt(data[1][j].Deaths, 10);
                    }
                }

                var today = {
                    Province_State: data[2][i].City,
                    Country_Region: 'US',
                    Lat: data[2][i].Latitude,
                    Long_: data[2][i].Longitude,
                    Confirmed: conf,
                    Recovered: rec,
                    Deaths: dead
                }

                conf = 0;
                rec = 0;
                dead = 0;

                // yesterday's data
                for (let j = 0; j < data[0].length; j++) {
                    if (data[0][j].Province_State === data[2][i].City) {
                        conf += parseInt(data[0][j].Confirmed, 10);
                        rec += parseInt(data[0][j].Recovered, 10);
                        dead += parseInt(data[0][j].Deaths, 10);
                    }
                }

                var yesterday = {
                    Province_State: data[2][i].City,
                    Country_Region: 'US',
                    Lat: data[2][i].Latitude,
                    Long_: data[2][i].Longitude,
                    Confirmed: conf,
                    Recovered: rec,
                    Deaths: dead
                }

                // do not plot points if no cases exist
                if (today.Confirmed != 0) {
                    plotPoint(today, yesterday);
                }
            }

            document.getElementById('activeCount').innerHTML = globalActive.toLocaleString();
            document.getElementById('recoveredCount').innerHTML = globalRecovered.toLocaleString();
            document.getElementById('deathCount').innerHTML = globalDeaths.toLocaleString();
            document.getElementById('changeCount').innerHTML = '<i class="arrow up icon"></i>' + globalNewCases.toLocaleString();

            function plotPoint(today, yesterday) {
                // data is weird, double check if Active is truly 0
                if (!today.Active || today.Active == 0) {
                    today.Active = parseInt(today.Confirmed, 10) - parseInt(today.Recovered, 10) - parseInt(today.Deaths, 10);
                }

                globalActive += parseInt(today.Active, 10);
                globalRecovered += parseInt(today.Recovered, 10);
                globalDeaths += parseInt(today.Deaths, 10);

                var radius = radii[6];
                if (today.Active <= 25) {
                    radius = radii[0];
                }
                else if (today.Active <= 100) {
                    radius = radii[1];
                }
                else if (today.Active <= 500) {
                    radius = radii[2];
                }
                else if (today.Active <= 1000) {
                    radius = radii[3];
                }
                else if (today.Active <= 5000) {
                    radius = radii[4];
                }
                else if (today.Active <= 10000) {
                    radius = radii[5];
                }

                var caseChange = 0;
                if (yesterday) {
                    caseChange = parseInt(today.Confirmed, 10) - parseInt(yesterday.Confirmed, 10);
                }
                else {
                    caseChange = parseInt(today.Confirmed, 10);
                }

                var dailyInfo;
                if (caseChange === 0) {
                    dailyInfo = 'New Cases: <strong>' + caseChange + '</strong><br>';
                }
                else {
                    dailyInfo = 'New Cases: <strong class="caseChange"><i class="arrow up icon"></i>' + caseChange + '</strong><br>'
                }

                globalNewCases += parseInt(caseChange, 10);
                    
                var color = '#ed2d1f';
                if (caseChange <= 10) {
                    color = '#fff4e9';
                }
                else if (caseChange <= 50) {
                    color = '#fccda8'
                }
                else if (caseChange <= 500) {
                    color = '#f8a36f'
                }
                else if (caseChange <= 1000) {
                    color = '#f37240'
                }
                
                // popup info
                if (today['Province_State']) {
                    popup = '<div id="PopupTitle">' + today['Province_State'] + ', ' + today['Country_Region'] + '</div>'
                            + '<div id="PopupBody">' + dailyInfo
                            + 'Active: <strong class="active">' + today.Active + '</strong><br>'
                            + 'Recovered: <strong class="recovered">' + today.Recovered + '</strong><br>' 
                            + 'Deaths: <strong class="deaths">' + today.Deaths + '</strong><br>'
                            + 'Total Cases: <strong class="confirmed">' + today.Confirmed + '</strong></div>';
                }
                else {
                    popup = '<div id="PopupTitle">' + today['Country_Region'] + '</div>'
                            + '<div id="PopupBody">' + dailyInfo
                            + 'Active: <strong class="active">' + today.Active + '</strong><br>'
                            + 'Recovered: <strong class="recovered">' + today.Recovered + '</strong><br>' 
                            + 'Deaths: <strong class="deaths">' + today.Deaths + '</strong><br>'
                            + 'Total Cases: <strong class="confirmed">' + today.Confirmed + '</strong></div>';
                }

                // dont plot garbage locations, but count their data towards totals
                if (today.Province_State !== 'Recovered') {
                    markers.push(L.circleMarker([today['Lat'], today['Long_']], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.65,
                        weight: 1,
                        radius: radius
                    }).bindPopup(popup)
                        .on('click', L.bind(makeChart, null, today.Country_Region, today.Province_State))
                        .on('popupclose', L.bind(makeChart, null, "Global")));
                }
            }

            // create layer group of all the markers
            var markerLayer = L.layerGroup(markers);

            L.mapbox.accessToken = 'pk.eyJ1IjoiamtiaXNoYXkiLCJhIjoiY2ptM3N4OGU5MGk5YTNxbW10dms2b2FyYyJ9.IH37mJFcTWUa6O3RH7b4cA';
            var mapLayer = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/dark-v9/tiles/{z}/{x}/{y}?access_token=' + L.mapbox.accessToken, {
                attribution: '© <a href="https://www.mapbox.com/feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            });

            // initialize geo map
            var mymap = L.map('map', {
                center: [28.1559614,6.6860949],
                zoom: 2, 
                minZoom: 2,
                maxZoom: 6,
                maxBounds: L.latLngBounds([-90, -240], [90, 240]),
                maxBoundsViscosity: 0.5,
                wheelPxPerZoomLevel: 200,
                layers: [mapLayer, markerLayer]
            });

            // check previous zoom level
            var oldZoom = mymap.getZoom();
            mymap.on('zoomstart', function() {
                oldZoom = mymap.getZoom();
                mymap.scrollWheelZoom.disable();
            });

            // change marker size on zoom
            mymap.on('zoomend', function() {
                var zoom = mymap.getZoom();
                var zoom2 = [1, 2, 3, 6, 8, 11, 14];
                var zoom3 = [2, 3, 6, 9, 12, 16, 22];
                var zoom4 = [4, 7, 11, 15, 19, 23, 30];
                var zoom5 = [6, 10, 14, 19, 24, 29, 36];

                // zooming into 3
                if (zoom == 3 && zoom > oldZoom) {
                    for (let i = 0; i < markers.length; i++) {
                        var rad = markers[i]._radius;
                        switch(rad) {
                            case zoom2[0]:
                                markers[i].setRadius(zoom3[0]);
                                break;
                            case zoom2[1]: 
                                markers[i].setRadius(zoom3[1]);
                                break;
                            case zoom2[2]: 
                                markers[i].setRadius(zoom3[2]);
                                break;
                            case zoom2[3]: 
                                markers[i].setRadius(zoom3[3]);
                                break;
                            case zoom2[4]: 
                                markers[i].setRadius(zoom3[4]);
                                break;
                            case zoom2[5]: 
                                markers[i].setRadius(zoom3[5]);
                                break;
                            case zoom2[6]: 
                                markers[i].setRadius(zoom3[6]);
                                break;
                        }
                    }
                }
                // zooming into 4
                else if (zoom == 4 && zoom > oldZoom) {
                    for (let i = 0; i < markers.length; i++) {
                        var rad = markers[i]._radius;
                        switch(rad) {
                            case zoom3[0]:
                                markers[i].setRadius(zoom4[0]);
                                break;
                            case zoom3[1]: 
                                markers[i].setRadius(zoom4[1]);
                                break;
                            case zoom3[2]: 
                                markers[i].setRadius(zoom4[2]);
                                break;
                            case zoom3[3]: 
                                markers[i].setRadius(zoom4[3]);
                                break;
                            case zoom3[4]: 
                                markers[i].setRadius(zoom4[4]);
                                break;
                            case zoom3[5]: 
                                markers[i].setRadius(zoom4[5]);
                                break;
                            case zoom3[6]: 
                                markers[i].setRadius(zoom4[6]);
                                break;
                        }
                    }
                }
                // zooming into 5
                else if (zoom == 5 && zoom > oldZoom) {
                    for (let i = 0; i < markers.length; i++) {
                        var rad = markers[i]._radius;
                        switch(rad) {
                            case zoom4[0]:
                                markers[i].setRadius(zoom5[0]);
                                break;
                            case zoom4[1]: 
                                markers[i].setRadius(zoom5[1]);
                                break;
                            case zoom4[2]: 
                                markers[i].setRadius(zoom5[2]);
                                break;
                            case zoom4[3]: 
                                markers[i].setRadius(zoom5[3]);
                                break;
                            case zoom4[4]: 
                                markers[i].setRadius(zoom5[4]);
                                break;
                            case zoom4[5]: 
                                markers[i].setRadius(zoom5[5]);
                                break;
                            case zoom4[6]: 
                                markers[i].setRadius(zoom5[6]);
                                break;
                        }
                    }
                }
                // zooming out to 4
                else if (zoom == 4 && zoom < oldZoom) {
                    for (let i = 0; i < markers.length; i++) {
                        var rad = markers[i]._radius;
                        switch(rad) {
                            case zoom5[0]:
                                markers[i].setRadius(zoom4[0]);
                                break;
                            case zoom5[1]: 
                                markers[i].setRadius(zoom4[1]);
                                break;
                            case zoom5[2]: 
                                markers[i].setRadius(zoom4[2]);
                                break;
                            case zoom5[3]: 
                                markers[i].setRadius(zoom4[3]);
                                break;
                            case zoom5[4]: 
                                markers[i].setRadius(zoom4[4]);
                                break;
                            case zoom5[5]: 
                                markers[i].setRadius(zoom4[5]);
                                break;
                            case zoom5[6]: 
                                markers[i].setRadius(zoom4[6]);
                                break;
                        }
                    }
                }
                // zooming out to 3
                else if (zoom == 3 && zoom < oldZoom) {
                    for (let i = 0; i < markers.length; i++) {
                        var rad = markers[i]._radius;
                        switch(rad) {
                            case zoom4[0]:
                                markers[i].setRadius(zoom3[0]);
                                break;
                            case zoom4[1]: 
                                markers[i].setRadius(zoom3[1]);
                                break;
                            case zoom4[2]: 
                                markers[i].setRadius(zoom3[2]);
                                break;
                            case zoom4[3]: 
                                markers[i].setRadius(zoom3[3]);
                                break;
                            case zoom4[4]: 
                                markers[i].setRadius(zoom3[4]);
                                break;
                            case zoom4[5]: 
                                markers[i].setRadius(zoom3[5]);
                                break;
                            case zoom4[6]: 
                                markers[i].setRadius(zoom3[6]);
                                break;
                        }
                    }
                }
                // zooming out to 2
                else if (zoom == 2 && zoom < oldZoom) {
                    for (let i = 0; i < markers.length; i++) {
                        var rad = markers[i]._radius;
                        switch(rad) {
                            case zoom3[0]:
                                markers[i].setRadius(zoom2[0]);
                                break;
                            case zoom3[1]: 
                                markers[i].setRadius(zoom2[1]);
                                break;
                            case zoom3[2]: 
                                markers[i].setRadius(zoom2[2]);
                                break;
                            case zoom3[3]: 
                                markers[i].setRadius(zoom2[3]);
                                break;
                            case zoom3[4]: 
                                markers[i].setRadius(zoom2[4]);
                                break;
                            case zoom3[5]: 
                                markers[i].setRadius(zoom2[5]);
                                break;
                            case zoom3[6]: 
                                markers[i].setRadius(zoom2[6]);
                                break;
                        }
                    }
                }
                mymap.scrollWheelZoom.enable();
            });
        });

        // initialize chart here so it can be destroyed for redraws
        var canvas = document.getElementById('infectionChart');
        var ctx = canvas.getContext('2d');
        var chart = new Chart(ctx, {
            type: 'line',
            options: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 12
                    }
                }
            }
        });

        // create chart based on selected region and province
        function makeChart(region, province = "") {
            // time series data for charts
            Promise.all([
                d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"),
                d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_recovered_global.csv"),
                d3.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
            ]).then(function (data) {
                var title = region;
                if (province != "" && region != "US" && region != "Canada" && region != "Global") {
                    title = province + ', ' + region;
                }
                else if (region == "US") {
                    title = "United States of America";
                }

                document.getElementById('infoTitle').innerHTML = title;
                chart.destroy();

                var dateLabels = [];
                var confs = [];
                var recs = [];
                var deaths = [];
                var active = [];
                var increase = [];
                if (region == "Global") {
                    for (let [key, value] of Object.entries(data[0][0])) {
                        if (key != "Province/State" && key != "Country/Region" && key != "Lat" && key != "Long") {
                            dateLabels.push(key);
                        }
                    }

                    for (let i = 0; i < Object.keys(data[0][0]).length - 4; i++) {
                        confs[i] = 0;
                    }
                    for (let i = 0; i < data[0].length; i++) {
                        let j = 0;
                        for (let [key, value] of Object.entries(data[0][i])) {
                            if (key != "Province/State" && key != "Country/Region" && key != "Lat" && key != "Long") {
                                confs[j] += parseInt(value, 10);
                                j++;
                            }
                        }
                    }

                    for (let i = 0; i < Object.keys(data[1][0]).length - 4; i++) {
                        recs[i] = 0;
                    }
                    for (let i = 0; i < data[1].length; i++) {
                        let j = 0;
                        for (let [key, value] of Object.entries(data[1][i])) {
                            if (key != "Province/State" && key != "Country/Region" && key != "Lat" && key != "Long") {
                                recs[j] += parseInt(value, 10);
                                j++;
                            }
                        }
                    }

                    for (let i = 0; i < Object.keys(data[2][0]).length - 4; i++) {
                        deaths[i] = 0;
                    }
                    for (let i = 0; i < data[2].length; i++) {
                        let j = 0;
                        for (let [key, value] of Object.entries(data[2][i])) {
                            if (key != "Province/State" && key != "Country/Region" && key != "Lat" && key != "Long") {
                                deaths[j] += parseInt(value, 10);
                                j++;
                            }
                        }
                    }
                }
                else {
                    var areaC = data[0].find(item => item['Country/Region'] === region && item['Province/State'] === province);
                    var areaR = data[1].find(item => item['Country/Region'] === region && item['Province/State'] === province);
                    var areaD = data[2].find(item => item['Country/Region'] === region && item['Province/State'] === province);

                    if (region == "Canada" || region == "US") {
                        areaC = data[0].find(item => item['Country/Region'] === region);
                        areaR = data[1].find(item => item['Country/Region'] === region);
                        areaD = data[2].find(item => item['Country/Region'] === region);
                    }

                    // CANADA IS A VERY SPECIAL CHILD
                    if (region == "Canada") {
                        for (let i = 0; i < Object.keys(data[0][0]).length - 4; i++) {
                            confs[i] = 0;
                        }
                        data[0].forEach(element => {
                            var i = 0;
                            if (element['Country/Region'] === region) {
                                for (let [key, value] of Object.entries(element)) {
                                    if (key != "Province/State" && key != "Country/Region" && key != "Lat" && key != "Long") {
                                        confs[i] += parseInt(value, 10);
                                        i++;
                                    }
                                }
                            }
                        });
                    }
                    else {
                        for (let [key, value] of Object.entries(areaC)) {
                            if (key != "Province/State" && key != "Country/Region" && key != "Lat" && key != "Long") {
                                confs.push(parseInt(value, 10));
                            }
                        }
                    }
                    for (let [key, value] of Object.entries(areaR)) {
                        if (key != "Province/State" && key != "Country/Region" && key != "Lat" && key != "Long") {
                            dateLabels.push(key);
                            recs.push(parseInt(value, 10));
                        }
                    }
                    for (let [key, value] of Object.entries(areaD)) {
                        if (key != "Province/State" && key != "Country/Region" && key != "Lat" && key != "Long") {
                            deaths.push(parseInt(value, 10));
                        }
                    }

                    var firstIdx = confs.findIndex(val => val >= 100);
                    if (firstIdx == -1 || firstIdx > confs.length - 5) {
                        firstIdx = confs.findIndex(val => val >= 1);
                    }
                    confs.splice(0, firstIdx);
                    recs.splice(0, firstIdx);
                    deaths.splice(0, firstIdx);
                    dateLabels.splice(0, firstIdx);
                }

                // create active cases data
                for (let i = 0; i < confs.length; i++) {
                    active.push(confs[i] - recs[i] - deaths[i]);
                }

                // create daily change data
                increase.push(confs[0]);
                for (let i = 0; i < confs.length - 1; i++) {
                    increase.push(confs[i+1] - confs[i]);
                }

                // reset buttons when redrawing chart
                document.getElementById('activeButton').className = "ui yellow button mini";
                document.getElementById('recoveredButton').className = "ui blue button mini";
                document.getElementById('deathButton').className = "ui purple button mini";
                document.getElementById('increaseButton').className = "ui red basic button mini";

                Chart.defaults.global.defaultFontColor = 'lightgray';
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dateLabels,
                        datasets: [
                            {
                                label: "Active Cases",
                                backgroundColor: "gold",
                                borderColor: "gold",
                                data: active,
                                pointRadius: 1,
                                fill: false
                            },
                            {
                                label: "Recovered",
                                backgroundColor: "dodgerblue",
                                borderColor: "dodgerblue",
                                data: recs,
                                pointRadius: 1,
                                fill: false
                            },
                            {
                                label: "Deaths",
                                backgroundColor: "orchid",
                                borderColor: "orchid",
                                data: deaths,
                                pointRadius: 1,
                                fill: false
                            },
                            {
                                label: "Daily Increase",
                                backgroundColor: "#ed2d1f",
                                borderColor: "#ed2d1f",
                                data: increase,
                                pointRadius: 1,
                                fill: false,
                                hidden: true
                            }
                        ]
                    },
                    options: {
                        legend: {
                            display: false,
                            position: 'bottom',
                            labels: {
                                boxWidth: 12
                            }
                        },
                        // scales: {
                        //     yAxes: [{
                        //         type: 'logarithmic'
                        //     }]
                        // }
                    }
                });
            });
        }

        // initialize page with global charts
        makeChart("Global");

        // handle click with dataset chart buttons
        function clickChartButton(buttonID) {
            var color = "";
            var set = "";
            switch (buttonID) {
                case 'activeButton':
                    color = "yellow";
                    set = "Active Cases";
                    break;
                case 'recoveredButton':
                    color = "blue";
                    set = "Recovered";
                    break;
                case 'deathButton':
                    color = "purple";
                    set = "Deaths";
                    break;
            }
            var button = document.getElementById(buttonID);
            if (button.classList.contains("basic")) {
                button.className = "ui " + color + " button mini";
                chart.data.datasets.find(item => item['label'] == set).hidden = false;
                // turn off daily change dataset
                document.getElementById('increaseButton').className = "ui red basic button mini";
                chart.data.datasets.find(item => item['label'] == "Daily Increase").hidden = true;
            }
            else {
                button.className = "ui " + color + " basic button mini";
                chart.data.datasets.find(item => item['label'] == set).hidden = true;
            }
            chart.update();
        }

        // handle click on daily change chart button
        function clickIncreaseButton() {
            var button = document.getElementById('increaseButton');
            if (button.classList.contains("basic")) {
                button.className = "ui red button mini";
                chart.data.datasets.find(item => item['label'] == "Daily Increase").hidden = false;
                // turn off other datasets
                document.getElementById('activeButton').className = "ui yellow basic button mini";
                chart.data.datasets.find(item => item['label'] == "Active Cases").hidden = true;
                document.getElementById('recoveredButton').className = "ui blue basic button mini";
                chart.data.datasets.find(item => item['label'] == "Recovered").hidden = true;
                document.getElementById('deathButton').className = "ui purple basic button mini";
                chart.data.datasets.find(item => item['label'] == "Deaths").hidden = true;
            }
            else {
                button.className = "ui red basic button mini";
                chart.data.datasets.find(item => item['label'] == "Daily Increase").hidden = true;
                // turn on other datasets
                document.getElementById('activeButton').className = "ui yellow button mini";
                chart.data.datasets.find(item => item['label'] == "Active Cases").hidden = false;
                document.getElementById('recoveredButton').className = "ui blue button mini";
                chart.data.datasets.find(item => item['label'] == "Recovered").hidden = false;
                document.getElementById('deathButton').className = "ui purple button mini";
                chart.data.datasets.find(item => item['label'] == "Deaths").hidden = false;
            }
            chart.update();
        }

        document.getElementById('lastUpdated').innerHTML = 'Last Updated on ' + currentMonth + '/' + currentDay + '/' + currentYear  
            + ' at 11:55 PM UTC <br> Data is provided by Johns Hopkins CSSE from ' 
            + '<a href="https://github.com/CSSEGISandData/COVID-19" target="_blank">GitHub</a>';
        
    </script>
</html>

