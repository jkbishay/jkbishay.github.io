<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>COVID-19 Growth Map</title>
        <link rel="stylesheet" href="index.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.2/semantic.min.css"/>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
                integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
                crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
                integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
                crossorigin=""></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src='https://api.mapbox.com/mapbox.js/v3.3.0/mapbox.js'></script>
        <link href='https://api.mapbox.com/mapbox.js/v3.3.0/mapbox.css' rel='stylesheet'/> 
    </head>
    <style>
        body {
            background-color: rgb(20, 20, 20); 
            height: 100%;
            width: 100%;
        }

        .leaflet-popup-content-wrapper {
            background-color: black;
        }
    </style>

    <body>
        <div id="titleBar">
            <h1>COVID-19 New Daily Cases and Active Cases by Country and Region</h1>
        </div>
        <div id="mainGrid">
            <div id="map"></div>
            <div class="ui equal width grid" id="info">
                <div class="column"><h2>Global Data</h2></div>
                <div class="row">
                    <div class="column">
                        <h3>New Cases</h3>
                        <div id="changeCount"></div>
                    </div>
                    <div class="column">
                        <h3>Active Cases</h3>
                        <div id="activeCount"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="column">
                        <h3>Recovered</h3>
                        <div id="recoveredCount"></div>
                    </div>
                    <div class="column">
                        <h3>Deaths</h3>
                        <div id="deathCount"></div>
                    </div>
                </div>
                <div class="row">
                    <div class="column legend" style="padding-left: 75px; padding-right: 75px;">
                        <h4>Number of New Cases</h4>
                        <i style="background: #ed2d1f;"></i> 1000+<br>
                        <i style="background: #f37240;"></i> 100-1000<br>
                        <i style="background: #f8a36f;"></i> 20-100<br>
                        <i style="background: #fccda8;"></i> 5-20<br>
                        <i style="background: #fff4e9;"></i> 0-5<br>
                    </div>
                </div>
                <div class="row">
                    <div class="column">
                        <p style="font-size: 10px;">Last Updated on March 25, 2020 at 12:00 AM GMT <br>
                            Data is provided by Johns Hopkins CSSE from <a href="https://github.com/CSSEGISandData/COVID-19">GitHub</a></p>
                    </div>
                </div>
            </div>
        </div>
        <div id="footer">
            <p>Developed by Justin Bishay, Computer Science M.S. Student, <a href="https://jkbishay.github.io/" target="_blank">Website</a></p>
            <div class="ui three column grid" style="margin-top: -25px; padding-left: 9%; padding-right: 9%;">
                <div class="column">
                    <p>
                        <a href="http://datascience.hawaii.edu/" target="_blank" style="color: lightgray;">
                            Hawaii Data Science Institute <img target="_blank" src="./HIDSILogo.png" style="width: 20px; height: 20px;"/>
                        </a>
                    </p>
                </div>
                <div class="column">
                    <p>
                        <a href="https://www.lavaflow.info/" target="_blank" style="color: lightgray;">
                            Laboratory for Advanced Visualization & Applications <img target="_blank" src="./lavaLogo.png" style="width: 45px; height: 22px;"/>
                        </a>
                    </p>
                </div>
                <div class="column">
                    <p>
                        <a href="https://manoa.hawaii.edu/" target="_blank" style="color: lightgray;">
                            University of Hawaii at Manoa <img target="_blank" src="./UHMLogo.png" style="width: 20px; height: 20px;"/>
                        </a>
                    </p>
                </div>
            </div>
            </div>
            <!-- <p>
                Laboratory for Advanced Visualization & Applications 
                <a href="https://www.lavaflow.info/" target="_blank"><img target="_blank" src="./lavaLogo.png" style="width: 45px; height: 22px;"/></a>
                &emsp; Hawaii Data Science Institute
                <a href="http://datascience.hawaii.edu/" target="_blank"><img target="_blank" src="./HIDSILogo.png" style="width: 20px; height: 20px;"/></a>
                &emsp; University of Hawaii at Manoa
                <a href="https://manoa.hawaii.edu/" target="_blank"><img target="_blank" src="./UHMLogo.png" style="width: 20px; height: 20px;"/></a>
            </p> -->
        </div>
    </body>

    <script>
        // initialize geo map
        var mymap = L.map('map').setView([34.9888971, -39.252909], 3);
        L.mapbox.accessToken = 'pk.eyJ1IjoiamtiaXNoYXkiLCJhIjoiY2ptM3N4OGU5MGk5YTNxbW10dms2b2FyYyJ9.IH37mJFcTWUa6O3RH7b4cA';
        L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/dark-v9/tiles/{z}/{x}/{y}?access_token=' + L.mapbox.accessToken, {
            attribution: '© <a href="https://www.mapbox.com/feedback/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        }).addTo(mymap);

        var currentDay = 25;
        var currentMonth = '03';

        // process data
        Promise.all([
            d3.csv("./COVID-19-master/csse_covid_19_data/csse_covid_19_daily_reports/" + currentMonth + "-" + (currentDay - 1) + "-2020.csv"),
            d3.csv("./COVID-19-master/csse_covid_19_data/csse_covid_19_daily_reports/" + currentMonth + "-" + currentDay + "-2020.csv"),
            d3.csv("./statelatlong.csv")
        ]).then(function (data) {
            // global totals counters
            var globalActive = 0;
            var globalRecovered = 0;
            var globalDeaths = 0;
            var globalNewCases = 0;

            // process data for non-USA regions
            for (let i = 0; i < data[1].length; i++) {
                var today = data[1][i];
                if (today.Country_Region !== 'US') {
                    var yesterday = data[0].find(item => item['Country_Region'] === today['Country_Region'] && item['Province_State'] === today['Province_State']);
                    plotPoint(today, yesterday);
                }
            }

            // process data for USA by state
            for (let i = 0; i < data[2].length; i++) {
                var conf = 0;
                var rec = 0;
                var dead = 0;

                // today's data
                for (let j = 0; j < data[1].length; j++) {
                    if (data[1][j].Province_State === data[2][i].City) {
                        conf += parseInt(data[1][j].Confirmed, 10);
                        rec += parseInt(data[1][j].Recovered, 10);
                        dead += parseInt(data[1][j].Deaths, 10);
                    }
                }

                var today = {
                    Province_State: data[2][i].City,
                    Country_Region: 'US',
                    Lat: data[2][i].Latitude,
                    Long_: data[2][i].Longitude,
                    Confirmed: conf,
                    Recovered: rec,
                    Deaths: dead
                }

                conf = 0;
                rec = 0;
                dead = 0;

                // yesterday's data
                for (let j = 0; j < data[0].length; j++) {
                    if (data[0][j].Province_State === data[2][i].City) {
                        conf += parseInt(data[0][j].Confirmed, 10);
                        rec += parseInt(data[0][j].Recovered, 10);
                        dead += parseInt(data[0][j].Deaths, 10);
                    }
                }

                var yesterday = {
                    Province_State: data[2][i].City,
                    Country_Region: 'US',
                    Lat: data[2][i].Latitude,
                    Long_: data[2][i].Longitude,
                    Confirmed: conf,
                    Recovered: rec,
                    Deaths: dead
                }

                plotPoint(today, yesterday);
            }

            document.getElementById('activeCount').innerHTML = globalActive;
            document.getElementById('recoveredCount').innerHTML = globalRecovered;
            document.getElementById('deathCount').innerHTML = globalDeaths;
            document.getElementById('changeCount').innerHTML = '<i class="arrow up icon"></i>' + globalNewCases;

            function plotPoint(today, yesterday) {
                // data is weird, double check if Active is truly 0
                if (!today.Active || today.Active == 0) {
                    today.Active = parseInt(today.Confirmed, 10) - parseInt(today.Recovered, 10) - parseInt(today.Deaths, 10);
                }

                globalActive += parseInt(today.Active, 10);
                globalRecovered += parseInt(today.Recovered, 10);
                globalDeaths += parseInt(today.Deaths, 10);

                var radius = 24;
                if (today.Active <= 25) {
                    radius = 2;
                }
                else if (today.Active <= 100) {
                    radius = 4;
                }
                else if (today.Active <= 500) {
                    radius = 7;
                }
                else if (today.Active <= 1000) {
                    radius = 9;
                }
                else if (today.Active <= 5000) {
                    radius = 13;
                }
                else if (today.Active <= 10000) {
                    radius = 17;
                }

                var caseChange = 0;
                if (yesterday) {
                    caseChange = parseInt(today.Confirmed, 10) - parseInt(yesterday.Confirmed, 10);
                }
                else {
                    caseChange = parseInt(today.Confirmed, 10);
                }

                var dailyInfo;
                if (caseChange === 0) {
                    dailyInfo = 'New Cases: <strong>' + caseChange + '</strong><br>';
                }
                else {
                    dailyInfo = 'New Cases: <strong class="caseChange"><i class="arrow up icon"></i>' + caseChange + '</strong><br>'
                }

                globalNewCases += parseInt(caseChange, 10);
                    
                var color = '#ed2d1f';
                if (caseChange <= 5) {
                    color = '#fff4e9';
                }
                else if (caseChange <= 20) {
                    color = '#fccda8'
                }
                else if (caseChange <= 100) {
                    color = '#f8a36f'
                }
                else if (caseChange <= 1000) {
                    color = '#f37240'
                }
                
                // popup info
                if (today['Province_State']) {
                    popup = '<div id="PopupTitle">' + today['Province_State'] + ', ' + today['Country_Region'] + '</div>'
                            + '<div id="PopupBody">' + dailyInfo
                            + 'Active: <strong class="active">' + today.Active + '</strong><br>'
                            + 'Recovered: <strong class="recovered">' + today.Recovered + '</strong><br>' 
                            + 'Deaths: <strong class="deaths">' + today.Deaths + '</strong><br>'
                            + 'Total Cases: <strong class="confirmed">' + today.Confirmed + '</strong></div>';
                }
                else {
                    popup = '<div id="PopupTitle">' + today['Country_Region'] + '</div>'
                            + '<div id="PopupBody">' + dailyInfo
                            + 'Active: <strong class="active">' + today.Active + '</strong><br>'
                            + 'Recovered: <strong class="recovered">' + today.Recovered + '</strong><br>' 
                            + 'Deaths: <strong class="deaths">' + today.Deaths + '</strong><br>'
                            + 'Total Cases: <strong class="confirmed">' + today.Confirmed + '</strong></div>';
                }

                L.circleMarker([today['Lat'], today['Long_']], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.7,
                    weight: 1,
                    radius: radius
                }).addTo(mymap).bindPopup(popup);
            }
        });
        
    </script>
</html>

